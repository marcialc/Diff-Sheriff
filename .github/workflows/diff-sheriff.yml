name: Diff-Sheriff Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate unified diff
        id: diff
        run: |
          git fetch --no-tags --prune --depth=1 origin "${{ github.base_ref }}"
          DIFF="$(git diff --unified=3 "origin/${{ github.base_ref }}"...HEAD)"
          echo "$DIFF" | head -c 60000 > /tmp/pr.diff
          echo "saved_diff=/tmp/pr.diff" >> "$GITHUB_OUTPUT"

      - name: Call Diff-Sheriff
        id: sheriff
        env:
          DIFF_SHERIFF_URL: https://diff-sheriff.marcialandres06.workers.dev
          DIFF_SHERIFF_TOKEN: ${{ secrets.DIFF_SHERIFF_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          DIFF_JSON=$(cat "${{ steps.diff.outputs.saved_diff }}" | jq -Rs .)
          RULES_MD=$(cat <<'EOF' | jq -Rs .
          ## Workflow / CI Rules
          - Do NOT flag GitHub Actions secrets references like `${{ secrets.DIFF_SHERIFF_TOKEN }}` as "hardcoded" or "exposed".
          - Only flag secrets if a literal token value is committed in plaintext.
          EOF
          )

          RESPONSE=$(curl -sS -X POST "$DIFF_SHERIFF_URL/review" \
            -H "Authorization: Bearer $DIFF_SHERIFF_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"diff\": $DIFF_JSON,
              \"provider\": \"github\",
              \"repo\": \"${{ github.repository }}\",
              \"prNumber\": ${{ github.event.pull_request.number }},
              \"sha\": \"${{ github.event.pull_request.head.sha }}\",
              \"title\": $(printf %s \"$PR_TITLE\" | jq -Rs .),
              \"description\": $(printf %s \"$PR_BODY\" | jq -Rs .),
              \"rulesMd\": $RULES_MD,
              \"mode\": \"summary\"
            }")

          echo "$RESPONSE" | jq .
          echo "response<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post PR review with inline comments
        uses: actions/github-script@v7
        env:
          RESPONSE: ${{ steps.sheriff.outputs.response }}
        with:
          script: |
            const response = JSON.parse(process.env.RESPONSE);
            if (!response.ok) {
              console.log('Review failed:', response.error);
              return;
            }
            
            const { summary, recommendation, inlineComments, commentMd } = response;
            
            // Map recommendation to GitHub review event
            const event = recommendation === 'approve' ? 'APPROVE' 
              : recommendation === 'request_changes' ? 'REQUEST_CHANGES' 
              : 'COMMENT';
            
            // Build review comments for inline feedback
            const comments = (inlineComments || []).map(c => ({
              path: c.path,
              line: c.line,
              body: c.body
            }));
            
            try {
              await github.rest.pulls.createReview({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: context.payload.pull_request.number,
                commit_id: context.payload.pull_request.head.sha,
                body: commentMd,
                event: event,
                comments: comments
              });
              console.log(`Posted review with ${comments.length} inline comments`);
            } catch (err) {
              console.error('Failed to post review:', err.message);
              // Fallback: post as regular comment if review fails
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.payload.pull_request.number,
                body: commentMd
              });
              console.log('Posted as regular comment instead');
            }
