name: Diff-Sheriff Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  review:
    if: github.event.pull_request.head.repo.full_name == github.repository
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate unified diff
        id: diff
        run: |
          git fetch --no-tags --prune --depth=1 origin "${{ github.base_ref }}"
          DIFF="$(git diff --unified=3 "origin/${{ github.base_ref }}"...HEAD)"
          echo "$DIFF" | head -c 60000 > /tmp/pr.diff
          echo "saved_diff=/tmp/pr.diff" >> "$GITHUB_OUTPUT"

      - name: Call Diff-Sheriff
        id: sheriff
        env:
          DIFF_SHERIFF_URL: https://diff-sheriff.marcialandres06.workers.dev
          DIFF_SHERIFF_TOKEN: ${{ secrets.DIFF_SHERIFF_TOKEN }}
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_BODY: ${{ github.event.pull_request.body }}
        run: |
          DIFF_JSON=$(cat "${{ steps.diff.outputs.saved_diff }}" | jq -Rs .)
          RULES_MD=$(cat <<'EOF' | jq -Rs .
          ## Workflow / CI Rules
          - Do NOT flag GitHub Actions secrets references like `${{ secrets.DIFF_SHERIFF_TOKEN }}` as "hardcoded" or "exposed".
          - Only flag secrets if a literal token value is committed in plaintext.
          EOF
          )

          RESPONSE=$(curl -sS -X POST "$DIFF_SHERIFF_URL/review" \
            -H "Authorization: Bearer $DIFF_SHERIFF_TOKEN" \
            -H "Content-Type: application/json" \
            -d "{
              \"diff\": $DIFF_JSON,
              \"provider\": \"github\",
              \"repo\": \"${{ github.repository }}\",
              \"prNumber\": ${{ github.event.pull_request.number }},
              \"sha\": \"${{ github.event.pull_request.head.sha }}\",
              \"title\": $(printf %s \"$PR_TITLE\" | jq -Rs .),
              \"description\": $(printf %s \"$PR_BODY\" | jq -Rs .),
              \"rulesMd\": $RULES_MD,
              \"mode\": \"summary\"
            }")

          echo "$RESPONSE" | jq .
          echo "response<<EOF" >> "$GITHUB_OUTPUT"
          echo "$RESPONSE" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Post review as PR comment
        env:
          RESPONSE: ${{ steps.sheriff.outputs.response }}
        run: |
          COMMENT_MD=$(echo "$RESPONSE" | jq -r '.commentMd // empty')
          if [ -z "$COMMENT_MD" ]; then
            echo "No commentMd in response, skipping comment"
            exit 0
          fi
          # Post the markdown comment using GitHub API
          jq -n --arg body "$COMMENT_MD" '{body: $body}' | \
          curl -sS -X POST \
            -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments" \
            -d @-
